# Network Policies for AI FinOps Platform
# Implements zero-trust network security with explicit allow rules

# Default deny all ingress/egress for the namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: ai-finops
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# Allow Prometheus to scrape all services in the namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scrape
  namespace: ai-finops
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9400  # DCGM Exporter
        - protocol: TCP
          port: 8080  # GPU Enricher
        - protocol: TCP
          port: 9003  # OpenCost
        - protocol: TCP
          port: 9090  # Prometheus (self-scrape)

---
# Prometheus network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus
  namespace: ai-finops
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: prometheus
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Grafana to query Prometheus
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - protocol: TCP
          port: 9090
    # Allow GPU Enricher to query Prometheus
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: gpu-enricher
      ports:
        - protocol: TCP
          port: 9090
    # Allow Alertmanager to receive alerts
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: alertmanager
      ports:
        - protocol: TCP
          port: 9090
  egress:
    # Allow scraping pods in namespace
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 9400
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 9003
        - protocol: TCP
          port: 9090
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow Alertmanager communication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: alertmanager
      ports:
        - protocol: TCP
          port: 9093

---
# Grafana network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana
  namespace: ai-finops
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow external access to Grafana UI
    - ports:
        - protocol: TCP
          port: 3000
  egress:
    # Allow querying Prometheus
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9090
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
# GPU Enricher network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gpu-enricher
  namespace: ai-finops
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: gpu-enricher
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus to scrape metrics
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 8080
    # Allow external API access
    - ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow querying Prometheus
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9090
    # Allow querying OpenCost
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: opencost
      ports:
        - protocol: TCP
          port: 9003
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
# OpenCost network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: opencost
  namespace: ai-finops
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: opencost
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus to scrape metrics
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9003
    # Allow GPU Enricher to query allocation API
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: gpu-enricher
      ports:
        - protocol: TCP
          port: 9003
    # Allow external access to UI
    - ports:
        - protocol: TCP
          port: 9090
  egress:
    # Allow querying Prometheus for cost data
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9090
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow cloud API access for pricing (AWS, GCP, Azure)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# DCGM Exporter network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dcgm-exporter
  namespace: ai-finops
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: dcgm-exporter
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus to scrape GPU metrics
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9400
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
# Alertmanager network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: alertmanager
  namespace: ai-finops
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: alertmanager
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus to send alerts
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9093
    # Allow external access to UI
    - ports:
        - protocol: TCP
          port: 9093
  egress:
    # Allow sending webhooks to Slack/PagerDuty
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

---
# Mock GPU metrics (local development only)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mock-gpu-metrics
  namespace: ai-finops
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: mock-gpu-metrics
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow Prometheus to scrape
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9400
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
