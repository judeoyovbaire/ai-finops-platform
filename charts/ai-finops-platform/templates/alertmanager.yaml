{{- if .Values.alertmanager.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: {{ include "ai-finops.namespace" . }}
  labels:
    {{- include "ai-finops.alertmanager.labels" . | nindent 4 }}
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname', 'team']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default'
      routes:
        - match:
            severity: critical
          receiver: 'critical'
        - match:
            severity: warning
          receiver: 'warning'
    receivers:
      - name: 'default'
        {{- if .Values.alertmanager.slack.enabled }}
        slack_configs:
          - api_url: {{ .Values.alertmanager.slack.webhookUrl | quote }}
            channel: {{ .Values.alertmanager.slack.channel | quote }}
            title: '{{ "{{" }} template "slack.default.title" . {{ "}}" }}'
            text: '{{ "{{" }} template "slack.default.text" . {{ "}}" }}'
        {{- end }}
      - name: 'warning'
        {{- if .Values.alertmanager.slack.enabled }}
        slack_configs:
          - api_url: {{ .Values.alertmanager.slack.webhookUrl | quote }}
            channel: {{ .Values.alertmanager.slack.channel | quote }}
        {{- end }}
      - name: 'critical'
        {{- if .Values.alertmanager.pagerduty.enabled }}
        pagerduty_configs:
          - service_key: {{ .Values.alertmanager.pagerduty.serviceKey | quote }}
        {{- end }}
        {{- if .Values.alertmanager.slack.enabled }}
        slack_configs:
          - api_url: {{ .Values.alertmanager.slack.webhookUrl | quote }}
            channel: {{ .Values.alertmanager.slack.channel | quote }}
        {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: {{ include "ai-finops.namespace" . }}
  labels:
    {{- include "ai-finops.alertmanager.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.alertmanager.replicas }}
  selector:
    matchLabels:
      {{- include "ai-finops.alertmanager.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "ai-finops.alertmanager.selectorLabels" . | nindent 8 }}
    spec:
      containers:
        - name: alertmanager
          image: "{{ .Values.alertmanager.image.repository }}:{{ .Values.alertmanager.image.tag }}"
          args:
            - '--config.file=/etc/alertmanager/alertmanager.yml'
            - '--storage.path=/alertmanager'
          ports:
            - containerPort: 9093
              name: http
          volumeMounts:
            - name: config
              mountPath: /etc/alertmanager
            - name: storage
              mountPath: /alertmanager
          resources:
            {{- toYaml .Values.alertmanager.resources | nindent 12 }}
      volumes:
        - name: config
          configMap:
            name: alertmanager-config
        - name: storage
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: {{ include "ai-finops.namespace" . }}
  labels:
    {{- include "ai-finops.alertmanager.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: 9093
      targetPort: 9093
      name: http
  selector:
    {{- include "ai-finops.alertmanager.selectorLabels" . | nindent 4 }}
{{- end }}